let markdownWorker;const CONFIG={STORAGE_KEY:"markdown_content",THEME_KEY:"markdown_theme",TOC_KEY:"markdown_toc_visible",DEBOUNCE_DELAY:200,READING_SPEED:200},THEMES=[{id:"github-light",name:"GitHub Light",colors:["#ffffff","#0969da","#1f2328"]},{id:"github-dark",name:"GitHub Dark",colors:["#0d1117","#58a6ff","#e6edf3"]},{id:"notion-light",name:"Notion Light",colors:["#ffffff","#2eaadc","#37352f"]},{id:"notion-dark",name:"Notion Dark",colors:["#191919","#529cca","#e6e6e4"]},{id:"obsidian",name:"Obsidian",colors:["#1e1e1e","#7c3aed","#dcddde"]},{id:"dracula",name:"Dracula",colors:["#282a36","#bd93f9","#f8f8f2"]},{id:"nord",name:"Nord",colors:["#2e3440","#88c0d0","#eceff4"]},{id:"solarized-light",name:"Solarized Light",colors:["#fdf6e3","#268bd2","#657b83"]},{id:"solarized-dark",name:"Solarized Dark",colors:["#002b36","#2aa198","#839496"]},{id:"one-dark",name:"One Dark",colors:["#282c34","#61afef","#abb2bf"]},{id:"monokai",name:"Monokai",colors:["#272822","#a6e22e","#f8f8f2"]},{id:"tokyo-night",name:"Tokyo Night",colors:["#1a1b26","#7aa2f7","#c0caf5"]},{id:"catppuccin-mocha",name:"Catppuccin Mocha",colors:["#1e1e2e","#cba6f7","#cdd6f4"]},{id:"catppuccin-latte",name:"Catppuccin Latte",colors:["#eff1f5","#8839ef","#4c4f69"]},{id:"rose-pine",name:"Ros√© Pine",colors:["#191724","#ebbcba","#e0def4"]},{id:"rose-pine-dawn",name:"Ros√© Pine Dawn",colors:["#faf4ed","#d7827e","#575279"]},{id:"gruvbox-dark",name:"Gruvbox Dark",colors:["#282828","#fabd2f","#ebdbb2"]},{id:"gruvbox-light",name:"Gruvbox Light",colors:["#fbf1c7","#d79921","#3c3836"]},{id:"midnight",name:"Midnight",colors:["#0a0a0f","#6366f1","#e4e4ef"]},{id:"paper",name:"Paper",colors:["#f5f5f0","#4a90d9","#2d2d2d"]},{id:"ocean",name:"Ocean",colors:["#0c1929","#29b6f6","#e3f2fd"]},{id:"forest",name:"Forest",colors:["#0d1f0d","#4caf50","#d4edda"]}],COMMANDS=[{id:"bold",title:"Bold",desc:"Make text bold",shortcut:["Ctrl","B"],icon:"B"},{id:"italic",title:"Italic",desc:"Make text italic",shortcut:["Ctrl","I"],icon:"I"},{id:"heading1",title:"Heading 1",desc:"Insert heading 1",shortcut:["Ctrl","1"],icon:"H1"},{id:"heading2",title:"Heading 2",desc:"Insert heading 2",shortcut:["Ctrl","2"],icon:"H2"},{id:"heading3",title:"Heading 3",desc:"Insert heading 3",shortcut:["Ctrl","3"],icon:"H3"},{id:"link",title:"Insert Link",desc:"Add a hyperlink",shortcut:["Ctrl","K"],icon:"üîó"},{id:"image",title:"Insert Image",desc:"Add an image",shortcut:["Ctrl","Shift","I"],icon:"üñºÔ∏è"},{id:"code",title:"Inline Code",desc:"Format as code",shortcut:["Ctrl","`"],icon:"</>"},{id:"codeblock",title:"Code Block",desc:"Insert code block",shortcut:["Ctrl","Shift","K"],icon:"{ }"},{id:"quote",title:"Blockquote",desc:"Insert blockquote",shortcut:["Ctrl","Shift","."],icon:'"'},{id:"ul",title:"Bullet List",desc:"Insert bullet list",shortcut:["Ctrl","Shift","8"],icon:"‚Ä¢"},{id:"ol",title:"Numbered List",desc:"Insert numbered list",shortcut:["Ctrl","Shift","7"],icon:"1."},{id:"task",title:"Task List",desc:"Insert task list",shortcut:[],icon:"‚òë"},{id:"table",title:"Insert Table",desc:"Add a table",shortcut:[],icon:"‚ñ¶"},{id:"hr",title:"Horizontal Rule",desc:"Insert divider",shortcut:[],icon:"‚Äî"},{id:"mermaid",title:"Mermaid Diagram",desc:"Insert diagram",shortcut:[],icon:"‚óá"},{id:"math",title:"Math (LaTeX)",desc:"Insert math formula",shortcut:[],icon:"‚àë"},{id:"export-pdf",title:"Export as PDF",desc:"Download PDF file",shortcut:["Ctrl","P"],icon:"üìÑ"},{id:"export-html",title:"Export as HTML",desc:"Download HTML file",shortcut:[],icon:"üåê"},{id:"export-md",title:"Export as Markdown",desc:"Download .md file",shortcut:["Ctrl","S"],icon:"üìù"},{id:"reading-mode",title:"Reading Mode",desc:"Distraction-free reading",shortcut:["F11"],icon:"üìñ"},{id:"toggle-toc",title:"Toggle Table of Contents",desc:"Show/hide TOC",shortcut:[],icon:"üìë"},{id:"undo",title:"Undo",desc:"Undo last action",shortcut:["Ctrl","Z"],icon:"‚Ü©"},{id:"redo",title:"Redo",desc:"Redo last action",shortcut:["Ctrl","Shift","Z"],icon:"‚Ü™"}],DEFAULT_MARKDOWN="# Markdown Viewer & Editor Online - Free Live Preview üöÄ\n\nWelcome to **MarkdownViewer.dev** - the best **online markdown viewer** and **markdown editor** with instant live preview!\n\n**Start writing now...**\n\n- üöÄ **Live Preview**: Real-time updates\n- üìÅ **Import**: Drag & drop .md files\n- üé® **22 Themes**: GitHub, Notion, Obsidian, and more\n- üìä **Mermaid & Math**: Supported\n- üì§ **Export**: PDF, HTML, Markdown\n\n> **Pro Tip**: Press Ctrl+K to open the command palette!\n",elements={markdownInput:document.getElementById("markdownInput"),previewContent:document.getElementById("previewContent"),wordCount:document.getElementById("wordCount"),charCount:document.getElementById("charCount"),readingTime:document.getElementById("readingTime"),themeMenuBtn:document.getElementById("themeMenuBtn"),themeDropdown:document.getElementById("themeDropdown"),themeList:document.getElementById("themeList"),exportBtn:document.getElementById("exportBtn"),exportDropdown:document.getElementById("exportDropdown"),tocToggle:document.getElementById("tocToggle"),tocSidebar:document.getElementById("tocSidebar"),tocContent:document.getElementById("tocContent"),tocClose:document.getElementById("tocClose"),readingModeBtn:document.getElementById("readingModeBtn"),readingModeContainer:document.getElementById("readingModeContainer"),readingModeContent:document.getElementById("readingModeContent"),readingModeClose:document.getElementById("readingModeClose"),commandPaletteBtn:document.getElementById("commandPaletteBtn"),commandPaletteOverlay:document.getElementById("commandPaletteOverlay"),commandSearch:document.getElementById("commandSearch"),commandList:document.getElementById("commandList"),floatingToolbar:document.getElementById("floatingToolbar"),copyMarkdownBtn:document.getElementById("copyMarkdownBtn"),copyHtmlBtn:document.getElementById("copyHtmlBtn"),toast:document.getElementById("toast"),toastMessage:document.getElementById("toastMessage"),mobileViewToggle:document.getElementById("mobileViewToggle"),resizeHandle:document.getElementById("resizeHandle"),toolsMenuBtn:document.getElementById("toolsMenuBtn"),toolsDropdown:document.getElementById("toolsDropdown")};let undoStack=[],redoStack=[],lastSavedContent="",mermaidCounter=0,selectedCommandIndex=0,filteredCommands=[...COMMANDS];const _u=e=>e.join("");function initMarked(){marked.use({breaks:!0,gfm:!0,mangle:!1,renderer:{code(e,t){let n=e,o=t;if("object"==typeof e&&(n=e.text||e.raw||"",o=e.lang||""),"mermaid"===o){return`<div class="mermaid" id="${"mermaid-"+mermaidCounter++}">${n}</div>`}return`<pre ${o?`data-language="${o}"`:""}><code class="language-${o}">${n}</code></pre>`}}})}async function highlightCodeBlocks(){const e=elements.previewContent.querySelectorAll("pre code");if(0===e.length)return;if("undefined"==typeof hljs){if("function"!=typeof window.lazyLoadHighlight)return;await window.lazyLoadHighlight()}let t=0;function n(){const o=Math.min(t+3,e.length);for(let n=t;n<o;n++)e[n].classList.contains("hljs")||hljs.highlightElement(e[n]);t=o,t<e.length&&("requestIdleCallback"in window?requestIdleCallback(n):setTimeout(n,16))}"requestIdleCallback"in window?requestIdleCallback(n):setTimeout(n,0)}function initMermaid(){if("undefined"==typeof mermaid)return;const e=document.documentElement.getAttribute("data-theme")?.includes("dark")||"obsidian"===document.documentElement.getAttribute("data-theme")||"dracula"===document.documentElement.getAttribute("data-theme")||"nord"===document.documentElement.getAttribute("data-theme")||"one-dark"===document.documentElement.getAttribute("data-theme")||"monokai"===document.documentElement.getAttribute("data-theme")||"tokyo-night"===document.documentElement.getAttribute("data-theme")||"catppuccin-mocha"===document.documentElement.getAttribute("data-theme")||"rose-pine"===document.documentElement.getAttribute("data-theme")||"gruvbox-dark"===document.documentElement.getAttribute("data-theme")||"midnight"===document.documentElement.getAttribute("data-theme")||"ocean"===document.documentElement.getAttribute("data-theme")||"forest"===document.documentElement.getAttribute("data-theme");mermaid.initialize({startOnLoad:!1,theme:e?"dark":"default",securityLevel:"loose"})}function preprocessMarkdown(e){return e=(e=(e=e.replace(/::center\s+(.+?)::/g,'<div class="text-center">$1</div>')).replace(/::right\s+(.+?)::/g,'<div class="text-right">$1</div>')).replace(/\/\/pagebreak\/\//g,'<div class="page-break"></div>')}async function renderMarkdown(){const e=elements.markdownInput.value;if(""===e.trim())return elements.previewContent.innerHTML='<p class="placeholder-text">Your rendered markdown will appear here...</p>',updateStats("",0,0),void updateTOC([]);const t=preprocessMarkdown(e),n=await new Promise((e,n)=>{const o=t=>{t.data.error?n(t.data.error):e(t.data.html),markdownWorker.removeEventListener("message",o)};markdownWorker.addEventListener("message",o),markdownWorker.onerror=e=>n(e.message),markdownWorker.postMessage(t)});elements.previewContent.innerHTML=n,mermaidCounter=0,e.includes("```mermaid")&&await renderMermaidDiagrams(),highlightCodeBlocks(),(e.includes("$")||e.includes("\\(")||e.includes("\\["))&&await renderMath(elements.previewContent);const o=countWords(e);updateStats(o,e.length,Math.ceil(o/CONFIG.READING_SPEED));updateTOC(extractHeadings(elements.previewContent)),elements.previewContent.querySelectorAll('input[type="checkbox"]').forEach((e,t)=>{e.setAttribute("aria-label",`Task item ${t+1}`)}),saveToLocalStorage()}async function renderMermaidDiagrams(){const e=elements.previewContent.querySelectorAll(".mermaid");if(0!==e.length)if("function"==typeof window.lazyLoadMermaid&&await window.lazyLoadMermaid(),"undefined"!=typeof mermaid){mermaid.mermaidAPI||initMermaid();for(const t of e)try{const e=t.id,n=t.textContent,{svg:o}=await mermaid.render(e+"-svg",n);t.innerHTML=o}catch(e){t.innerHTML=`<div style="color: var(--code-text); padding: 1rem;">Mermaid Error: ${e.message}</div>`}}else console.warn("Mermaid library not loaded")}async function renderMath(e){"function"==typeof window.lazyLoadKaTeX&&"undefined"==typeof katex&&await window.lazyLoadKaTeX(),"undefined"!=typeof renderMathInElement&&renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1})}function countWords(e){return e.trim().split(/\s+/).filter(e=>e.length>0).length}function updateStats(e,t,n){elements.wordCount.textContent=`${e.toLocaleString()} words`,elements.charCount.textContent=`${t.toLocaleString()} chars`,elements.readingTime.textContent=`${n} min read`}function extractHeadings(e){const t=[];return e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((e,n)=>{const o=parseInt(e.tagName.charAt(1)),a=e.textContent,i=`heading-${n}`;e.id=i,t.push({level:o,text:a,id:i})}),t}function updateTOC(e){if(0===e.length)return void(elements.tocContent.innerHTML='<p class="toc-empty">No headings found</p>');const t=e.map(e=>`\n        <a class="toc-item toc-h${e.level}" href="#${e.id}" data-target="${e.id}">\n            ${e.text}\n        </a>\n    `).join("");elements.tocContent.innerHTML=t,elements.tocContent.querySelectorAll(".toc-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=document.getElementById(e.dataset.target);n&&n.scrollIntoView({behavior:"smooth"})})})}function initTheme(){setTheme(localStorage.getItem(CONFIG.THEME_KEY)||"github-light"),buildThemeList()}function setTheme(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem(CONFIG.THEME_KEY,e),document.querySelectorAll(".theme-option").forEach(t=>{t.classList.toggle("active",t.dataset.theme===e)}),initMermaid(),elements.markdownInput.value.includes("```mermaid")&&renderMarkdown()}function buildThemeList(){elements.themeList.innerHTML=THEMES.map(e=>`\n        <div class="theme-option" data-theme="${e.id}">\n            <div class="theme-preview">\n                ${e.colors.map(e=>`<div class="theme-preview-color" style="background: ${e}"></div>`).join("")}\n            </div>\n            <span class="theme-option-name">${e.name}</span>\n        </div>\n    `).join(""),elements.themeList.querySelectorAll(".theme-option").forEach(e=>{e.addEventListener("click",()=>{setTheme(e.dataset.theme),elements.themeDropdown.classList.remove("show"),showToast(`Theme: ${THEMES.find(t=>t.id===e.dataset.theme).name}`)})})}function saveToLocalStorage(){const e=elements.markdownInput.value;e!==lastSavedContent&&(localStorage.setItem(CONFIG.STORAGE_KEY,e),lastSavedContent=e)}function loadFromLocalStorage(){const e=localStorage.getItem(CONFIG.STORAGE_KEY);elements.markdownInput.value=null!==e&&""!==e?e:DEFAULT_MARKDOWN,lastSavedContent=elements.markdownInput.value;const t="true"===localStorage.getItem(CONFIG.TOC_KEY);elements.tocSidebar.classList.toggle("show",t)}function saveUndoState(){undoStack.push(elements.markdownInput.value),undoStack.length>100&&undoStack.shift(),redoStack=[]}function undo(){undoStack.length>0&&(redoStack.push(elements.markdownInput.value),elements.markdownInput.value=undoStack.pop(),renderMarkdown(),showToast("Undo"))}function redo(){redoStack.length>0&&(undoStack.push(elements.markdownInput.value),elements.markdownInput.value=redoStack.pop(),renderMarkdown(),showToast("Redo"))}function insertText(e,t="",n=""){const o=elements.markdownInput,a=o.selectionStart,i=o.selectionEnd,s=o.value.substring(a,i),r=s||n;saveUndoState(),o.value=o.value.substring(0,a)+e+r+t+o.value.substring(i);const d=a+e.length+(s?r.length:0);o.setSelectionRange(s?a+e.length:d,s?a+e.length+r.length:d),o.focus(),renderMarkdown()}function insertAtLineStart(e){const t=elements.markdownInput,n=t.selectionStart,o=t.value;let a=n;for(;a>0&&"\n"!==o[a-1];)a--;saveUndoState(),t.value=o.substring(0,a)+e+o.substring(a),t.setSelectionRange(n+e.length,n+e.length),t.focus(),renderMarkdown()}window.lazyLoadMermaid=function(){return window.mermaid?Promise.resolve():new Promise(function(e){var t=document.createElement("script");t.src=_u(["https://","cdn.","jsdelivr.net","/npm/","mermaid","/dist/","mermaid.min.js"]),t.onload=e,document.head.appendChild(t)})},window.lazyLoadHighlight=function(){return"undefined"!=typeof hljs?Promise.resolve():new Promise(function(e,t){var n=document.createElement("script");n.src=_u(["https://","cdnjs.","cloudflare.com","/ajax/libs/","highlight.js/","11.9.0/","highlight.min.js"]),n.onload=e,n.onerror=t,document.head.appendChild(n)})},window.lazyLoadKaTeX=function(){return window.katex?Promise.resolve():Promise.all([new Promise(function(e){var t=document.createElement("script");t.src=_u(["https://","cdn.","jsdelivr.net","/npm/","katex@0.16.9","/dist/","katex.min.js"]),t.onload=e,document.head.appendChild(t)}),new Promise(function(e){var t=document.createElement("script");t.src=_u(["https://","cdn.","jsdelivr.net","/npm/","katex@0.16.9","/dist/contrib/","auto-render.min.js"]),t.onload=e,document.head.appendChild(t)})])},window.lazyLoadPDF=function(){return window.html2pdf?Promise.resolve():new Promise(function(e){var t=document.createElement("script");t.src=_u(["https://","cdnjs.","cloudflare.com","/ajax/libs/","html2pdf.js/","0.10.1/","html2pdf.bundle.min.js"]),t.onload=e,document.head.appendChild(t)})};const FORMATTING_ACTIONS={bold:()=>insertText("**","**","bold text"),italic:()=>insertText("*","*","italic text"),strikethrough:()=>insertText("~~","~~","strikethrough"),h1:()=>insertAtLineStart("# "),h2:()=>insertAtLineStart("## "),h3:()=>insertAtLineStart("### "),ul:()=>insertAtLineStart("- "),ol:()=>insertAtLineStart("1. "),task:()=>insertAtLineStart("- [ ] "),link:()=>insertText("[","](url)","link text"),image:()=>insertText("![","](url)","alt text"),code:()=>insertText("`","`","code"),codeblock:()=>insertText("```javascript\n","\n```","code here"),quote:()=>insertAtLineStart("> "),hr:()=>insertText("\n---\n","",""),table:()=>insertText("\n| Column 1 | Column 2 |\n|----------|----------|\n| Cell 1   | Cell 2   |\n","",""),mermaid:()=>insertText("```mermaid\ngraph TD\n    A[Start] --\x3e B[End]\n```\n","",""),math:()=>insertText("$$\n","\n$$","E = mc^2"),undo:()=>undo(),redo:()=>redo()};function exportMarkdown(){const e=elements.markdownInput.value;downloadBlob(new Blob([e],{type:"text/markdown;charset=utf-8"}),"document.md"),showToast("Downloaded as Markdown")}function exportHTML(){const e=elements.previewContent.innerHTML;downloadBlob(new Blob([`<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Markdown Export</title>\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">\n    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">\n    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">\n    <style>\n        body {\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 2rem;\n            line-height: 1.7;\n            color: #1f2328;\n            background: #ffffff;\n        }\n        h1, h2, h3, h4, h5, h6 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600; }\n        h1 { font-size: 2rem; border-bottom: 2px solid #d0d7de; padding-bottom: 0.3em; }\n        h2 { font-size: 1.5rem; border-bottom: 1px solid #d0d7de; padding-bottom: 0.2em; }\n        code { font-family: 'JetBrains Mono', monospace; background: #f6f8fa; padding: 0.2em 0.4em; border-radius: 4px; }\n        pre { background: #24292e; color: #e1e4e8; padding: 1rem; border-radius: 8px; overflow-x: auto; }\n        pre code { background: transparent; padding: 0; }\n        blockquote { border-left: 4px solid #0969da; background: #f6f8fa; padding: 0.75em 1em; margin: 1em 0; border-radius: 0 8px 8px 0; }\n        table { width: 100%; border-collapse: collapse; margin: 1em 0; }\n        th, td { padding: 0.75rem; border: 1px solid #d0d7de; text-align: left; }\n        th { background: #f6f8fa; }\n        a { color: #0969da; }\n        img { max-width: 100%; }\n        .text-center { text-align: center; }\n        .text-right { text-align: right; }\n        .mermaid { text-align: center; padding: 1rem; background: #f6f8fa; border-radius: 8px; }\n        @media print { body { max-width: none; } .page-break { page-break-after: always; } }\n    </style>\n</head>\n<body>\n${e}\n<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"><\/script>\n<script>mermaid.initialize({ startOnLoad: true });<\/script>\n</body>\n</html>`],{type:"text/html;charset=utf-8"}),"document.html"),showToast("Downloaded as HTML")}async function exportPDF(){if(showToast("Preparing PDF export..."),"undefined"==typeof html2pdf){if("function"!=typeof window.lazyLoadPDF)return void showToast("PDF library not available","error");showToast("Loading PDF library..."),await window.lazyLoadPDF()}showToast("Generating PDF...");const e=elements.previewContent.cloneNode(!0);e.style.padding="0";const t={margin:[15,15,15,15],filename:"document.pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all","css","legacy"]}};try{await html2pdf().set(t).from(e).save(),showToast("Downloaded as PDF")}catch(e){showToast("PDF export failed","error"),console.error("PDF export error:",e)}}function downloadBlob(e,t){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,o.click(),URL.revokeObjectURL(n)}function openCommandPalette(){elements.commandPaletteOverlay.classList.add("show"),elements.commandSearch.value="",filterCommands(""),selectedCommandIndex=0,updateCommandSelection(),setTimeout(()=>elements.commandSearch.focus(),50)}function closeCommandPalette(){elements.commandPaletteOverlay.classList.remove("show"),elements.markdownInput.focus()}function filterCommands(e){const t=e.toLowerCase();filteredCommands=COMMANDS.filter(e=>e.title.toLowerCase().includes(t)||e.desc.toLowerCase().includes(t)),renderCommandList()}function renderCommandList(){elements.commandList.innerHTML=filteredCommands.map((e,t)=>`\n        <div class="command-item ${t===selectedCommandIndex?"selected":""}" data-command="${e.id}">\n            <div class="command-item-icon">${e.icon}</div>\n            <div class="command-item-content">\n                <div class="command-item-title">${e.title}</div>\n                <div class="command-item-desc">${e.desc}</div>\n            </div>\n            ${e.shortcut.length?`\n                <div class="command-item-shortcut">\n                    ${e.shortcut.map(e=>`<kbd>${e}</kbd>`).join("")}\n                </div>\n            `:""}\n        </div>\n    `).join(""),elements.commandList.querySelectorAll(".command-item").forEach((e,t)=>{e.addEventListener("click",()=>executeCommand(filteredCommands[t].id)),e.addEventListener("mouseenter",()=>{selectedCommandIndex=t,updateCommandSelection()})})}function updateCommandSelection(){elements.commandList.querySelectorAll(".command-item").forEach((e,t)=>{e.classList.toggle("selected",t===selectedCommandIndex)});const e=elements.commandList.querySelector(".command-item.selected");e&&e.scrollIntoView({block:"nearest"})}function executeCommand(e){switch(closeCommandPalette(),e){case"bold":FORMATTING_ACTIONS.bold();break;case"italic":FORMATTING_ACTIONS.italic();break;case"heading1":FORMATTING_ACTIONS.h1();break;case"heading2":FORMATTING_ACTIONS.h2();break;case"heading3":FORMATTING_ACTIONS.h3();break;case"link":FORMATTING_ACTIONS.link();break;case"image":FORMATTING_ACTIONS.image();break;case"code":FORMATTING_ACTIONS.code();break;case"codeblock":FORMATTING_ACTIONS.codeblock();break;case"quote":FORMATTING_ACTIONS.quote();break;case"ul":FORMATTING_ACTIONS.ul();break;case"ol":FORMATTING_ACTIONS.ol();break;case"task":FORMATTING_ACTIONS.task();break;case"table":FORMATTING_ACTIONS.table();break;case"hr":FORMATTING_ACTIONS.hr();break;case"mermaid":FORMATTING_ACTIONS.mermaid();break;case"math":FORMATTING_ACTIONS.math();break;case"export-pdf":exportPDF();break;case"export-html":exportHTML();break;case"export-md":exportMarkdown();break;case"reading-mode":openReadingMode();break;case"toggle-toc":toggleTOC();break;case"undo":undo();break;case"redo":redo()}}function openReadingMode(){elements.readingModeContent.innerHTML=elements.previewContent.innerHTML,renderMath(elements.readingModeContent),elements.readingModeContainer.classList.add("show"),document.body.style.overflow="hidden"}function closeReadingMode(){elements.readingModeContainer.classList.remove("show"),document.body.style.overflow=""}function toggleTOC(){const e=elements.tocSidebar.classList.toggle("show");localStorage.setItem(CONFIG.TOC_KEY,e)}function syncScroll(){const e=elements.markdownInput,t=elements.previewContent,n=e.scrollTop/(e.scrollHeight-e.clientHeight);t.scrollTop=n*(t.scrollHeight-t.clientHeight)}let toastTimeout;function showToast(e,t="success"){clearTimeout(toastTimeout),elements.toastMessage.textContent=e,elements.toast.classList.remove("error"),"error"===t&&elements.toast.classList.add("error"),elements.toast.classList.add("show"),toastTimeout=setTimeout(()=>{elements.toast.classList.remove("show")},2500)}async function copyToClipboard(e,t){try{await navigator.clipboard.writeText(e),showToast(t)}catch{const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),showToast(t)}}function initResizeHandle(){let e,t,n=!1;const o=document.querySelector(".editor-panel"),a=document.querySelector(".preview-panel");elements.resizeHandle.addEventListener("mousedown",a=>{n=!0,e=a.clientX,t=o.offsetWidth,document.body.style.cursor="col-resize",document.body.style.userSelect="none"}),document.addEventListener("mousemove",i=>{if(!n)return;const s=i.clientX-e,r=t+s,d=o.parentElement.offsetWidth;r>=200&&r<=d-200&&(o.style.flex="none",o.style.width=`${r}px`,a.style.flex="1")}),document.addEventListener("mouseup",()=>{n&&(n=!1,document.body.style.cursor="",document.body.style.userSelect="")})}function initMobileView(){const e=document.querySelector(".editor-panel"),t=document.querySelector(".preview-panel");e.classList.add("mobile-active"),elements.mobileViewToggle.addEventListener("click",n=>{if(n.target.classList.contains("view-btn")){const o=n.target.dataset.view;document.querySelectorAll(".view-btn").forEach(e=>{e.classList.toggle("active",e.dataset.view===o)}),e.classList.toggle("mobile-active","editor"===o),t.classList.toggle("mobile-active","preview"===o)}})}function handleKeyboardShortcuts(e){const t=e.ctrlKey||e.metaKey;if(t&&"k"===e.key)return e.preventDefault(),void openCommandPalette();if(elements.commandPaletteOverlay.classList.contains("show"))"Escape"===e.key?closeCommandPalette():"ArrowDown"===e.key?(e.preventDefault(),selectedCommandIndex=Math.min(selectedCommandIndex+1,filteredCommands.length-1),updateCommandSelection()):"ArrowUp"===e.key?(e.preventDefault(),selectedCommandIndex=Math.max(selectedCommandIndex-1,0),updateCommandSelection()):"Enter"===e.key&&(e.preventDefault(),filteredCommands[selectedCommandIndex]&&executeCommand(filteredCommands[selectedCommandIndex].id));else{if("F11"===e.key)return e.preventDefault(),void(elements.readingModeContainer.classList.contains("show")?closeReadingMode():openReadingMode());if("Escape"!==e.key)return t&&"s"===e.key?(e.preventDefault(),saveToLocalStorage(),void showToast("Saved!")):t&&"p"===e.key?(e.preventDefault(),void exportPDF()):void(document.activeElement===elements.markdownInput&&(t&&"b"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.bold()):t&&"i"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.italic()):t&&"1"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.h1()):t&&"2"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.h2()):t&&"3"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.h3()):t&&"`"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.code()):t&&e.shiftKey&&"K"===e.key?(e.preventDefault(),FORMATTING_ACTIONS.codeblock()):t&&"z"===e.key&&!e.shiftKey?(e.preventDefault(),undo()):t&&e.shiftKey&&"Z"===e.key&&(e.preventDefault(),redo())));elements.readingModeContainer.classList.contains("show")&&closeReadingMode()}}function handleTabKey(e){if("Tab"===e.key){e.preventDefault();const t=elements.markdownInput.selectionStart,n=elements.markdownInput.selectionEnd;saveUndoState(),elements.markdownInput.value=elements.markdownInput.value.substring(0,t)+"    "+elements.markdownInput.value.substring(n),elements.markdownInput.selectionStart=elements.markdownInput.selectionEnd=t+4,renderMarkdown()}}function initEventListeners(){let e,t;elements.markdownInput.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(renderMarkdown,CONFIG.DEBOUNCE_DELAY)}),elements.markdownInput.addEventListener("keydown",handleTabKey),elements.markdownInput.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(syncScroll,50)}),elements.themeMenuBtn.addEventListener("click",e=>{e.stopPropagation(),elements.themeDropdown.classList.toggle("show"),elements.exportDropdown.classList.remove("show")}),elements.exportBtn.addEventListener("click",e=>{e.stopPropagation(),elements.exportDropdown.classList.toggle("show"),elements.themeDropdown.classList.remove("show")}),document.querySelectorAll(".export-option").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.format;switch(elements.exportDropdown.classList.remove("show"),t){case"md":exportMarkdown();break;case"html":exportHTML();break;case"pdf":exportPDF()}})}),document.addEventListener("click",()=>{elements.themeDropdown.classList.remove("show"),elements.exportDropdown.classList.remove("show")}),elements.tocToggle.addEventListener("click",toggleTOC),elements.tocClose.addEventListener("click",toggleTOC),elements.readingModeBtn.addEventListener("click",openReadingMode),elements.readingModeClose.addEventListener("click",closeReadingMode),elements.commandPaletteBtn.addEventListener("click",openCommandPalette),elements.commandPaletteOverlay.addEventListener("click",e=>{e.target===elements.commandPaletteOverlay&&closeCommandPalette()}),elements.commandSearch.addEventListener("input",e=>{filterCommands(e.target.value),selectedCommandIndex=0,updateCommandSelection()}),elements.floatingToolbar.querySelectorAll(".toolbar-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;FORMATTING_ACTIONS[t]&&FORMATTING_ACTIONS[t]()})}),elements.copyMarkdownBtn.addEventListener("click",()=>{copyToClipboard(elements.markdownInput.value,"Markdown copied!")}),elements.copyHtmlBtn.addEventListener("click",()=>{copyToClipboard(elements.previewContent.innerHTML,"HTML copied!")}),document.addEventListener("keydown",handleKeyboardShortcuts),elements.markdownInput.addEventListener("dragover",e=>{e.preventDefault(),elements.markdownInput.style.opacity="0.7"}),elements.markdownInput.addEventListener("dragleave",()=>{elements.markdownInput.style.opacity="1"}),elements.markdownInput.addEventListener("drop",e=>{e.preventDefault(),elements.markdownInput.style.opacity="1";const t=e.dataTransfer.files[0];if(t&&(t.name.endsWith(".md")||t.name.endsWith(".markdown")||"text/plain"===t.type)){const e=new FileReader;e.onload=e=>{saveUndoState(),elements.markdownInput.value=e.target.result,renderMarkdown(),showToast(`Loaded: ${t.name}`)},e.readAsText(t)}})}const GROQ_API_KEY_STORAGE="groq_api_key";let GROQ_API_KEY=localStorage.getItem("groq_api_key")||("undefined"!=typeof CONFIG_API_KEY?CONFIG_API_KEY:"");const GROQ_API_URL="https://api.groq.com/openai/v1/chat/completions",GROQ_MODEL="llama-3.3-70b-versatile";function setGroqApiKey(){const e=prompt("Enter your Groq API Key (get one free at console.groq.com):");return!(!e||!e.trim())&&(GROQ_API_KEY=e.trim(),localStorage.setItem("groq_api_key",GROQ_API_KEY),showToast("API Key saved!"),!0)}const aiElements={sidebar:document.getElementById("aiSidebar"),toggle:document.getElementById("aiToggle"),close:document.getElementById("aiClose"),messages:document.getElementById("aiMessages"),input:document.getElementById("aiInput"),sendBtn:document.getElementById("aiSendBtn")};let aiConversation=[];function toggleAISidebar(){aiElements.sidebar.classList.toggle("show"),document.getElementById("historySidebar").classList.remove("show")}function addAIMessage(e,t="assistant"){const n=document.createElement("div");n.className=`ai-message ai-message-${t}`,n.innerHTML=`<div class="ai-message-content">${e}</div>`,aiElements.messages.appendChild(n),aiElements.messages.scrollTop=aiElements.messages.scrollHeight}function showAILoading(){const e=document.createElement("div");e.className="ai-message ai-message-assistant ai-loading",e.innerHTML='<div class="ai-message-loading"><span></span><span></span><span></span></div>',e.id="ai-loading",aiElements.messages.appendChild(e),aiElements.messages.scrollTop=aiElements.messages.scrollHeight}function hideAILoading(){const e=document.getElementById("ai-loading");e&&e.remove()}async function callGroqAPI(e){try{const t=await fetch(GROQ_API_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${GROQ_API_KEY}`},body:JSON.stringify({model:GROQ_MODEL,messages:e,max_tokens:2048,temperature:.7})});if(!t.ok)throw new Error(`API error: ${t.status}`);return(await t.json()).choices[0].message.content}catch(e){throw console.error("Groq API error:",e),e}}async function sendAIMessage(){const e=aiElements.input.value.trim();if(e)if(GROQ_API_KEY||setGroqApiKey()){addAIMessage(e,"user"),aiElements.input.value="",aiConversation.push({role:"user",content:e}),showAILoading(),aiElements.sendBtn.disabled=!0;try{const e={role:"system",content:`You are a specialized Markdown Writing Assistant for markdownviewer.dev. Your ONLY purpose is to help users write and edit their markdown documents.\n\n## YOUR CAPABILITIES:\n- Help write and improve markdown content\n- Fix grammar, spelling, and clarity issues\n- Suggest better formatting\n- Summarize or expand text\n- Generate content ideas\n\n## STRICT RULES:\n1. ONLY answer questions about the user's markdown document, writing, editing, or markdown syntax\n2. If asked unrelated questions (math, coding puzzles, history, general knowledge), politely say "I can only help with your markdown document" and suggest a document-related task\n3. Keep responses SHORT (2-4 sentences)\n\n## CRITICAL - RESPONSE FORMAT:\n- Write in PLAIN TEXT only\n- Do NOT use code blocks or markdown headers\n- Put EACH suggestion on its OWN LINE with a number (1. 2. 3.)\n- Use "‚Üí" arrows for changes: 'old' ‚Üí 'new'\n- Add a blank line between each numbered point\n\nEXAMPLE RESPONSE:\n"Here are my suggestions:\n\n1. Change 'Stuff' ‚Üí 'Getting Started' for a clearer heading\n\n2. Add a blank line before your bullet list\n\n3. Fix typo: 'teh' ‚Üí 'the'"\n\nEXAMPLE BAD RESPONSE (DO NOT DO THIS):\n\`\`\`markdown\n# Getting Started\n\`\`\`\n\n## USER'S CURRENT DOCUMENT:\n"""\n${elements.markdownInput.value.substring(0,2e3)}${elements.markdownInput.value.length>2e3?"\n...(truncated)":""}\n"""\n\nRemember: Plain text only! Be friendly and brief.`},t=await callGroqAPI([e,...aiConversation.slice(-10)]);hideAILoading(),addAIMessage(t,"assistant"),aiConversation.push({role:"assistant",content:t})}catch(e){hideAILoading(),addAIMessage(`‚ùå Error: ${e.message}. Please try again.`,"assistant")}aiElements.sendBtn.disabled=!1}else addAIMessage("‚ö†Ô∏è Please set your Groq API key to use the AI assistant. Click the message to try again.","assistant")}async function handleAIAction(e){if(!GROQ_API_KEY&&!setGroqApiKey())return void showToast("API key required for AI features","error");const t=elements.markdownInput.value.substring(elements.markdownInput.selectionStart,elements.markdownInput.selectionEnd),n=elements.markdownInput.value;let o="";switch(e){case"grammar":o=t?`Check the grammar and clarity of this text and provide corrections:\n\n"${t}"`:`Check the grammar and clarity of this markdown document and list any issues:\n\n${n.substring(0,3e3)}`;break;case"rewrite":if(!t)return void showToast("Please select text to rewrite","error");o=`Rewrite this text to be clearer and more professional:\n\n"${t}"`;break;case"summarize":o=`Summarize this markdown document in 3-5 bullet points:\n\n${n.substring(0,4e3)}`;break;case"expand":if(!t)return void showToast("Please select text to expand","error");o=`Expand and elaborate on this text with more details:\n\n"${t}"`;break;case"format":o=`Review this markdown and suggest formatting improvements (headings, lists, code blocks, etc.):\n\n${n.substring(0,3e3)}`;break;case"generate":o=`Based on this document, suggest what content could be added next:\n\n${n.substring(0,2e3)}`;break;default:return}aiElements.sidebar.classList.contains("show")||toggleAISidebar(),addAIMessage(`[${e.toUpperCase()}] ${o.substring(0,100)}...`,"user"),showAILoading();try{const e="You are a Markdown Writing Assistant. Help users improve their documents.\n\nCRITICAL RULES:\n1. Write in PLAIN TEXT only\n2. Do NOT use code blocks or markdown headers\n3. Put EACH point on its OWN LINE with numbers (1. 2. 3.)\n4. Use \"‚Üí\" for changes: 'old' ‚Üí 'new'\n5. Add blank line between numbered points\n\nEXAMPLE:\n\"Here are my suggestions:\n\n1. Your heading 'Stuff' ‚Üí 'Getting Started' would be clearer\n\n2. Add a blank line before your list\n\n3. Fix: 'their' ‚Üí 'there'\"\n\nBe friendly!",t=await callGroqAPI([{role:"system",content:e},{role:"user",content:o}]);hideAILoading(),addAIMessage(t,"assistant")}catch(e){hideAILoading(),addAIMessage(`‚ùå Error: ${e.message}`,"assistant")}}function initAI(){aiElements.toggle&&(aiElements.toggle.addEventListener("click",toggleAISidebar),aiElements.close.addEventListener("click",toggleAISidebar),aiElements.sendBtn.addEventListener("click",sendAIMessage),aiElements.input.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendAIMessage())}),document.querySelectorAll(".ai-action-btn").forEach(e=>{e.addEventListener("click",()=>handleAIAction(e.dataset.action))}))}const HISTORY_KEY="markdown_history",MAX_VERSIONS=20,historyElements={sidebar:document.getElementById("historySidebar"),toggle:document.getElementById("historyToggle"),close:document.getElementById("historyClose"),list:document.getElementById("historyList"),saveBtn:document.getElementById("saveVersionBtn"),clearBtn:document.getElementById("clearHistoryBtn")};function toggleHistorySidebar(){historyElements.sidebar.classList.toggle("show"),document.getElementById("aiSidebar").classList.remove("show"),renderHistoryList()}function getVersionHistory(){const e=localStorage.getItem(HISTORY_KEY);return e?JSON.parse(e):[]}function saveVersionHistory(e){localStorage.setItem(HISTORY_KEY,JSON.stringify(e))}function saveVersion(){const e=elements.markdownInput.value;if(!e.trim())return void showToast("Nothing to save","error");const t=getVersionHistory(),n={id:Date.now(),timestamp:(new Date).toISOString(),content:e,preview:e.substring(0,100),wordCount:countWords(e)};t.unshift(n),t.length>20&&t.pop(),saveVersionHistory(t),renderHistoryList(),showToast("Version saved!")}function restoreVersion(e){const t=getVersionHistory().find(t=>t.id===e);t&&(saveUndoState(),elements.markdownInput.value=t.content,renderMarkdown(),showToast("Version restored!"))}function deleteVersion(e){let t=getVersionHistory();t=t.filter(t=>t.id!==e),saveVersionHistory(t),renderHistoryList(),showToast("Version deleted")}function clearHistory(){confirm("Are you sure you want to clear all saved versions?")&&(localStorage.removeItem(HISTORY_KEY),renderHistoryList(),showToast("History cleared"))}function formatTimestamp(e){const t=new Date(e),n=new Date-t;return n<6e4?"Just now":n<36e5?`${Math.floor(n/6e4)} min ago`:n<864e5?`${Math.floor(n/36e5)} hours ago`:t.toLocaleDateString()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function renderHistoryList(){const e=getVersionHistory();0!==e.length?(historyElements.list.innerHTML=e.map(e=>`\n        <div class="history-item" data-id="${e.id}">\n            <div class="history-item-header">\n                <span class="history-item-time">${formatTimestamp(e.timestamp)}</span>\n                <div class="history-item-actions">\n                    <button class="history-item-btn restore-btn" title="Restore this version">\n                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>\n                            <path d="M3 3v5h5"/>\n                        </svg>\n                    </button>\n                    <button class="history-item-btn delete-btn" title="Delete this version">\n                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M3 6h18"/>\n                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                        </svg>\n                    </button>\n                </div>\n            </div>\n            <div class="history-item-preview">${e.preview.replace(/</g,"&lt;")}...</div>\n            <div class="history-item-stats">${e.wordCount} words</div>\n        </div>\n    `).join(""),historyElements.list.querySelectorAll(".history-item").forEach(e=>{const t=parseInt(e.dataset.id);e.querySelector(".restore-btn").addEventListener("click",e=>{e.stopPropagation(),restoreVersion(t)}),e.querySelector(".delete-btn").addEventListener("click",e=>{e.stopPropagation(),deleteVersion(t)})})):historyElements.list.innerHTML='<p class="history-empty">No saved versions yet.<br>Click "Save Version" to create a snapshot.</p>'}function initHistory(){historyElements.toggle&&(historyElements.toggle.addEventListener("click",toggleHistorySidebar),historyElements.close.addEventListener("click",toggleHistorySidebar),historyElements.saveBtn.addEventListener("click",saveVersion),historyElements.clearBtn.addEventListener("click",clearHistory))}const findElements={bar:document.getElementById("findReplaceBar"),findInput:document.getElementById("findInput"),replaceInput:document.getElementById("replaceInput"),findCount:document.getElementById("findCount"),findPrevBtn:document.getElementById("findPrevBtn"),findNextBtn:document.getElementById("findNextBtn"),replaceBtn:document.getElementById("replaceBtn"),replaceAllBtn:document.getElementById("replaceAllBtn"),closeBtn:document.getElementById("findCloseBtn")};let findMatches=[],currentMatchIndex=0;function toggleFindReplace(){if(findElements.bar.classList.toggle("show"),findElements.bar.classList.contains("show")){findElements.findInput.focus();const e=elements.markdownInput.value.substring(elements.markdownInput.selectionStart,elements.markdownInput.selectionEnd);e&&(findElements.findInput.value=e,performFind())}}function performFind(){const e=findElements.findInput.value,t=elements.markdownInput.value;if(findMatches=[],currentMatchIndex=0,!e)return void(findElements.findCount.textContent="0 results");let n=0;for(;-1!==(n=t.toLowerCase().indexOf(e.toLowerCase(),n));)findMatches.push(n),n+=e.length;findElements.findCount.textContent=`${findMatches.length} results`,findMatches.length>0&&highlightMatch(0)}function highlightMatch(e){if(0===findMatches.length)return;currentMatchIndex=e;const t=findMatches[e],n=findElements.findInput.value;elements.markdownInput.focus(),elements.markdownInput.setSelectionRange(t,t+n.length),findElements.findCount.textContent=`${e+1}/${findMatches.length}`}function findNext(){if(0===findMatches.length)return;highlightMatch((currentMatchIndex+1)%findMatches.length)}function findPrev(){if(0===findMatches.length)return;highlightMatch((currentMatchIndex-1+findMatches.length)%findMatches.length)}function replaceOne(){if(0===findMatches.length)return;const e=findElements.findInput.value,t=findElements.replaceInput.value;saveUndoState();const n=elements.markdownInput.value,o=findMatches[currentMatchIndex];elements.markdownInput.value=n.substring(0,o)+t+n.substring(o+e.length),renderMarkdown(),performFind(),showToast("Replaced 1 match")}function replaceAll(){const e=findElements.findInput.value,t=findElements.replaceInput.value;if(!e||0===findMatches.length)return;saveUndoState();const n=findMatches.length;elements.markdownInput.value=elements.markdownInput.value.split(e).join(t),renderMarkdown(),performFind(),showToast(`Replaced ${n} matches`)}function initFindReplace(){findElements.bar&&(findElements.findInput.addEventListener("input",performFind),findElements.findNextBtn.addEventListener("click",findNext),findElements.findPrevBtn.addEventListener("click",findPrev),findElements.replaceBtn.addEventListener("click",replaceOne),findElements.replaceAllBtn.addEventListener("click",replaceAll),findElements.closeBtn.addEventListener("click",toggleFindReplace),findElements.findInput.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),e.shiftKey?findPrev():findNext()),"Escape"===e.key&&toggleFindReplace()}))}const shareElements={overlay:document.getElementById("shareModalOverlay"),close:document.getElementById("shareClose"),link:document.getElementById("shareLink"),copyBtn:document.getElementById("copyShareLink")};function openShareModal(){const e=elements.markdownInput.value,t=btoa(unescape(encodeURIComponent(e))),n=`${window.location.origin}${window.location.pathname}?doc=${t}`;shareElements.link.value=n,shareElements.overlay.classList.add("show")}function closeShareModal(){shareElements.overlay.classList.remove("show")}function loadFromURL(){const e=new URLSearchParams(window.location.search).get("doc");if(e)try{const t=decodeURIComponent(escape(atob(e)));elements.markdownInput.value=t,renderMarkdown(),showToast("Document loaded from URL"),window.history.replaceState({},"",window.location.pathname)}catch(e){console.error("Failed to load document from URL:",e)}}function initShare(){shareElements.overlay&&(shareElements.close.addEventListener("click",closeShareModal),shareElements.overlay.addEventListener("click",e=>{e.target===shareElements.overlay&&closeShareModal()}),shareElements.copyBtn.addEventListener("click",()=>{shareElements.link.select(),navigator.clipboard.writeText(shareElements.link.value),showToast("Share link copied!")}))}function initPhase2Shortcuts(){document.addEventListener("keydown",e=>{const t=e.ctrlKey||e.metaKey;t&&"f"===e.key&&(e.preventDefault(),toggleFindReplace()),("F3"===e.key||t&&"g"===e.key)&&(e.preventDefault(),findElements.bar.classList.contains("show")&&(e.shiftKey?findPrev():findNext()))})}COMMANDS.push({id:"share",title:"Share Document",desc:"Generate shareable link",shortcut:[],icon:"üîó"},{id:"find-replace",title:"Find & Replace",desc:"Search and replace text",shortcut:["Ctrl","F"],icon:"üîç"},{id:"save-version",title:"Save Version",desc:"Save current version to history",shortcut:[],icon:"üíæ"});const originalExecuteCommand=executeCommand;function initSEOToggle(){const e=document.getElementById("seoToggle"),t=document.getElementById("seoArticle");e&&t&&e.addEventListener("click",()=>{const n="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",!n),t.classList.toggle("show")})}function initToolsDropdown(){elements.toolsMenuBtn&&elements.toolsDropdown&&(elements.toolsMenuBtn.addEventListener("click",e=>{e.stopPropagation(),elements.toolsDropdown.classList.toggle("show"),elements.themeDropdown.classList.remove("show"),elements.exportDropdown.classList.remove("show")}),document.addEventListener("click",e=>{elements.toolsDropdown.contains(e.target)||elements.toolsMenuBtn.contains(e.target)||elements.toolsDropdown.classList.remove("show")}))}function init(){initTheme(),loadFromLocalStorage(),initEventListeners(),initResizeHandle(),initMobileView(),initToolsDropdown(),initSEOToggle(),initMarkdownWorker(),initAI(),initHistory(),initFindReplace(),initShare(),initPhase2Shortcuts(),loadFromURL(),"undefined"!=typeof marked?(initMarked(),deferredRender()):setTimeout(()=>{initMarked(),deferredRender()},100),elements.markdownInput.focus(),console.log("üìù Markdown Viewer initialized - Performance Optimized")}function deferredRender(){"requestIdleCallback"in window?requestIdleCallback(()=>{renderMarkdown(),elements.markdownInput.value.includes("```mermaid")&&initMermaid()},{timeout:1e3}):setTimeout(()=>{renderMarkdown(),elements.markdownInput.value.includes("```mermaid")&&initMermaid()},100)}executeCommand=function(e){switch(e){case"share":return void openShareModal();case"find-replace":return void toggleFindReplace();case"save-version":return void saveVersion();default:originalExecuteCommand(e)}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init();